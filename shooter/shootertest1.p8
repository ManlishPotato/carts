pico-8 cartridge // http://www.pico-8.com
version 36
__lua__
p={}
p.x=64
p.y=120
p.lx=p.x
p.ly=p.y
p.dir=3
p.spr=1
p.sprdir={1,2,3,4}

dbg={}
dbg.a=0
dbg.b=0
dbg.str="nil"

crt={}
crt.sprmap={6,7,8}
crt.crates={}
crt.startLife=4

blt={}
blt.bullets={}
blt.bulletSpd=2

cmra={}
cmra.x=0
cmra.y=0

function _init()
	getCrates()
end

function _update60()
	cls()

	map(0,0,0,0,16,16)

	bulletMove()
	bulletCollision()
	bulletDraw()

	control()
	collision()

	spr(p.spr,p.x,p.y)

	debug()
end

function getCrates()
	--create an table entry for all crates on the map plus the life
	for y=0,cmra.x+15,1 do
		for x=0,cmra.y+15,1 do
			if(mget(x,y)==crt.sprmap[1]) then
				add(crt.crates,x)
				add(crt.crates,y)
				add(crt.crates,crt.startLife)
			end
		end
	end
end

function bulletMove()
	for i=1,#blt.bullets,3 do
		if(blt.bullets[i+2]==1) then blt.bullets[i]-=blt.bulletSpd end
		if(blt.bullets[i+2]==2) then blt.bullets[i]+=blt.bulletSpd end
		if(blt.bullets[i+2]==3) then blt.bullets[i+1]-=blt.bulletSpd end
		if(blt.bullets[i+2]==4) then blt.bullets[i+1]+=blt.bulletSpd end
	end
end

function bulletCollision()
	local delCount=0
	--Map collision for crate:
	for i=1,#blt.bullets,3 do
		--save the sprite num
		local cellx=flr(blt.bullets[i]/8)
		local celly=flr(blt.bullets[i+1]/8)
		local cellspr=mget(cellx,celly)

		--crate collision
		if(fget(cellspr,1)) then
			--flagged change the map spr
			for v=1,#crt.crates,3 do
				if(cellx==crt.crates[v] and celly==crt.crates[v+1]) then
					crt.crates[v+2]-=1
					if(crt.crates[v+2]==(crt.startLife/2)) then mset(cellx,celly,crt.sprmap[2]) end
					if(crt.crates[v+2]<=0) then mset(cellx,celly,crt.sprmap[3]) end
				end
			end
			--remove the bullet
			for v=0,2,1 do blt.bullets[i+v]=-200 delCount+=1 end
		end

		--general collision, rock for ex
		if(fget(cellspr,2)) then
			--remove the bullet
			for v=0,2,1 do blt.bullets[i+v]=-200 delCount+=1 end
		end

		if(cellx>(cmra.x+15) or cellx<cmra.x or celly>(cmra.y+15) or celly<cmra.x) then
			for v=0,2,1 do blt.bullets[i+v]=-200 delCount+=1 end
		end
	end

	for i=1,delCount,1 do del(blt.bullets,-200) end
end

function bulletDraw()
	for i=1,#blt.bullets,3 do
		pset(blt.bullets[i],blt.bullets[i+1],0)
	end
end

function bulletAdd(ox,oy,dir)
	if(dir==1) then oy+=2 end
	if(dir==2) then ox+=7 oy+=5 end
	if(dir==3) then ox+=5 end
	if(dir==4) then ox+=2 oy+=7 end

	add(blt.bullets,ox)
	add(blt.bullets,oy)
	add(blt.bullets,dir)
end

function debug()
	rectfill(0,0,23,23,8)
	print(p.x,nil,nil,11)
	print(p.y,nil,7,11)
	print(":"..flr(p.x/8),12,0,11)
	print(":"..flr(p.y/8),12,7,11)

	print("blt:"..(#blt.bullets)/3,nil,15,11)
end

function collision()
	local state=false

	for i=0,1,1 do
		for v=0,1,1 do
			if(fget(mget(flr((p.x+(v*7))/8),flr((p.y+(i*7))/8)),0)) then state=true end
		end
	end

	if(state) then
		p.x=p.lx
		p.y=p.ly
	end
end

function control()
	p.lx=p.x
	p.ly=p.y

	if(btn(0,0)) then p.x-=1 p.dir=1 end
	if(btn(1,0)) then p.x+=1 p.dir=2 end
	if(btn(2,0)) then p.y-=1 p.dir=3 end
	if(btn(3,0)) then p.y+=1 p.dir=4 end

	if(btnp(4,0)) then bulletAdd(p.x,p.y,p.dir) end

	for i=1,4,1 do if(p.dir==i) then p.spr=p.sprdir[i] end end
end
__gfx__
0000000000011100000110000000f500006666007777777755555555500555557757777777777777777770007777777777000777777777070000000000000000
0000000000f101100011110000111500011111007177777756444465560444657777447777777676777706660777777777060777777700600000000000000000
007007005555511661fff110011105f0111fff107777775754644645546046457760467777776666777066666077777770060777777707600000000000000000
00077000f10fff1661fff11011fff511105fff117777777754466445544064457770647777766666770677766507777700760077777076600000000000000000
00077000011fff1661fff01f11fff501115fff11777777775446644554000445777004777766d1d1705666665dd077770765d077777066d00000000000000000
00700700011fff166115555501fff1110f50111077777777546446455404404077744757666dd11170655665dddd00770665d007770766d00000000000000000
000000000111110001101f00001111100051110077577777564444655044440577777777666d11117066655ddddd5507065ddd0070666dd00000000000000000
00000000001110000011100000666600005f000077777777555555555505555076777777766d11117066665dddd5dd07065dddd006666d100000000000000000
00000000000000000000000000000000000000007777777777777777777777777557775700000000706666655d5ddd0777777777000000000000000000000000
000000000000000000000000000000000000000077777767777777777777777775555757000000007077667665dddd0777777777000000000000000000000000
000000000000000000000000000000000000000077777777777777777777777775775557000000007067777665ddddd077777077000000000000000000000000
0000000000000000000000000000000000000000777777777777777777777777757777570000000006666666655dddd077000607000000000000000000000000
00000000000000000000000000000000000000007777777777777777777777777557775700000000066666665dd5ddd070766607000000000000000000000000
0000000000000000000000000000000000000000777777777757777777777777755557570000000006666665dd005dd0076666d0000000000000000000000000
0000000000000000000000000000000000000000777777777777777777777777757755570000000000606665d077005076666dd0000000000000000000000000
00000000000000000000000000000000000000007777777777777777777777777577775700000000700700000777770066666d10000000000000000000000000
__gff__
0000000000000303000105050505000000000000000000000000050505000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0515151515161516171705171617171700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1515161615161716171717171617050500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1515050517171717171717161705090500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1515060617170917160505051717051700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1717060617171717171706060515151700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1717171705161617171706051515171700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1715171717171717151515151706051700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1515151509060606060505151706171700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1515051517170505051717151706051700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c17171515171717151717171717171c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1c0a0b17171717151717150517170a0b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
091a1b171717171815181716171c1a1b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1c0c0a0b1716171816181616170a0b0900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c0d1a1b17161618161816170d1a1b0c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0a0b0c1c0c171618151815170c1c0a0b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1a1b1c0c1c1c17181518170c1c0d1a1b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
