pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
p1={}
p1.x=0
p1.y=0
p1.lastx=0
p1.lasty=0

p1.spr=18
p1.r=0
p1.lastr=0
p1.sel=0
p1.grav=0.25

tet_i={56,0, -8,0,4} --1
tet_t={56,0, -8,0,3, 0,8,1} --2

function _init()
	table=tet_t --set start tetramino
	p1.x,p1.y=table[1],table[2] --set start pos
end

function _update()
	cls()
	map(0,0,0,0,16,16)

	move()
	collision("move")
	rotate()
	collision("rot")

	gravity()
	collision("gravity")

	tetri("draw")
end

function mapset()
	local pos_x=0
	local pos_y=0
	local rot_x=0
 local rot_y=0

 for i=1,table[5],1 do
 	rot_x,rot_y=rot(table[3]+pos_x,table[4]+pos_y)
		mset((p1.x+rot_x)/8,(p1.y+rot_y)/8,p1.spr)
 	pos_x+=8
 end

 if(table[6]!=nil) then
 	pos_x=0
 	pos_y=0

		for n=1,table[8],1 do
			rot_x,rot_y=rot(table[6]+pos_x,table[7]+pos_y)
			mset((p1.x+rot_x)/8,(p1.y+rot_y)/8,p1.spr)
			pos_x+=8
		end
	end
end

function init_tet()
	mapset()

	p1.spr=flr(rnd(6))+18
	p1.sel=flr(rnd(2))+1
	p1.r=0

	if(p1.sel==1) then table=tet_i end
	if(p1.sel==2) then table=tet_t end

	p1.x,p1.y=table[1],table[2]
end

function gravity()
	p1.lastx,p1.lasty=p1.x,p1.y
	if(btn(3)) then p1.y+=p1.grav+1 else p1.y+=p1.grav end
end

function move()
	--movement buttonmap
	if(btnp(0)) then p1.x-=8 end
	if(btnp(1)) then p1.x+=8 end
end

function rotate()
	--save last rotation
	p1.lastr=p1.r

	--rotation buttonmap
	if(btnp(4)) then p1.r+=90 end
	if(p1.r>270) then p1.r=0 end
end

function collision(op)
	local pos_x=0
	local pos_y=0
	local rot_x=0
 local rot_y=0

 for i=1,table[5],1 do
 	rot_x,rot_y=rot(table[3]+pos_x,table[4]+pos_y)
 	for k=0,7,7 do
 		for l=0,7,7 do
				if(op=="gravity") then
					flag=fget(mget((p1.x+rot_x+l)/8,(p1.y+rot_y+k)/8),0)
	 			if(flag) then
						p1.y=p1.lasty
						init_tet()
	 			end
				end
				if(op=="move") then
	 			flag=fget(mget((p1.x+rot_x+l)/8,(p1.y+rot_y+k)/8),0)
	 			if(flag) then
	 				p1.x=p1.lastx
	 			end
			 end
				if(op=="rot") then
					flag=fget(mget((p1.x+rot_x+l)/8,(p1.y+rot_y+k)/8),0)
					if(flag) then
						p1.r=p1.lastr
				 end
				end
   end
	 end
		pos_x+=8
 end

 if(table[6]!=nil) then
 	pos_x,pos_y=0,0
		for n=1,table[8],1 do
			rot_x,rot_y=rot(table[6]+pos_x,table[7]+pos_y)
			for v=0,7,7 do
	 		for b=0,7,7 do
					if(op=="gravity") then
						flag=fget(mget((p1.x+rot_x+b)/8,(p1.y+rot_y+v)/8),0)
		 			if(flag) then
							p1.y=p1.lasty
		 				init_tet()
		 			end
					end
					if(op=="move") then
		 			flag=fget(mget((p1.x+rot_x+b)/8,(p1.y+rot_y+v)/8),0)
		 			if(flag) then
		 				p1.x=p1.lastx
		 			end
					end
					if(op=="rot") then
						flag=fget(mget((p1.x+rot_x+b)/8,(p1.y+rot_y+v)/8),0)
						if(flag) then
							p1.r=p1.lastr
						end
					end
 			end
 		end
		pos_x+=8
	 end
 end
end

function tetri(op)
	local pos_x=0
	local pos_y=0
	local rot_x=0
 local rot_y=0

 for i=1,table[5],1 do
 	rot_x,rot_y=rot(table[3]+pos_x,table[4]+pos_y)
		if(op=="draw") then spr(p1.spr,p1.x+rot_x,p1.y+rot_y) end
 	pos_x+=8
 end
 if(table[6]!=nil) then
 	pos_x, pos_y=0,0
		for n=1,table[8],1 do
			rot_x,rot_y=rot(table[6]+pos_x,table[7]+pos_y)
			if(op=="draw") then spr(p1.spr,p1.x+rot_x,p1.y+rot_y) end
			pos_x+=8
		end
 end
end

function rot(val_x,val_y)
 if(p1.r==0) then
 	return val_x,val_y
	end

	if(p1.r==90) then
	 return (val_y)*-1,val_x
	end

	if(p1.r==180) then
		return (val_x)*-1,(val_y)*-1
	end

	if(p1.r==270) then
	 return val_y,(val_x)*-1
	end
end

__gfx__
0000000077777777888888881111111181888188bbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000077777777800000081000000181888118bbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070077777777800000081000000181888818bbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700077777777800000081000000181188818bbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700077777777800000081000000188188118bbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070077777777800000081000000188188188bbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000077777777800000081000000181188188bbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000077777777888888881111111181888188bbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000bbbbbbbbaaaaaaaacccccccc4444444422222222888888880000000000000000000000000000000000000000000000000000000000000000
0000000000000000b888888babbbbbbacaaaaaac4cccccc424444442822222280000000000000000000000000000000000000000000000000000000000000000
0000000000000000b888888babbbbbbacaaaaaac4cccccc424444442822222280000000000000000000000000000000000000000000000000000000000000000
0000000000000000b888888babbbbbbacaaaaaac4cccccc424444442822222280000000000000000000000000000000000000000000000000000000000000000
0000000000000000b888888babbbbbbacaaaaaac4cccccc424444442822222280000000000000000000000000000000000000000000000000000000000000000
0000000000000000b888888babbbbbbacaaaaaac4cccccc424444442822222280000000000000000000000000000000000000000000000000000000000000000
0000000000000000b888888babbbbbbacaaaaaac4cccccc424444442822222280000000000000000000000000000000000000000000000000000000000000000
0000000000000000bbbbbbbbaaaaaaaacccccccc4444444422222222888888880000000000000000000000000000000000000000000000000000000000000000
__gff__
0001010001010000000000000000000000000101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0401010000000000000000000001010400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0401010000000000000000000001010400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0401010000000000000000000001010400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0401010000000000000000000001010400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0401010000000000000000000001010400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0401010000000000000000000001010400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0401010000000000000000000001010400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0401010000000000000000000001010400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0401010000000000000000000001010400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0401010000000000000000000001010400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0401010000000000000000000001010400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0401010000000000000000000001010400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0401010000000000000000000001010400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0401010000000000000000000001010400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0401010000000000000000000001010400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0401010101010101010101010101010400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
